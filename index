"use client";

import React, { useState, useRef, useEffect } from 'react';
import { Video, VideoOff, Target, Settings, Send, Moon, Sun, Volume2, ShieldAlert, Zap, Terminal } from 'lucide-react';

export default function PlateWatcherPro() {
  const [isMonitoring, setIsMonitoring] = useState(false);
  const [isEcoMode, setIsEcoMode] = useState(false);
  const [targetPlate, setTargetPlate] = useState("");
  const [geminiKey, setGeminiKey] = useState("");
  const [telegramToken, setTelegramToken] = useState("");
  const [telegramChatId, setTelegramChatId] = useState("");
  const [log, setLog] = useState<string[]>([]);
  const [showSettings, setShowSettings] = useState(false);

  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const wakeLockRef = useRef<any>(null);

  const speakAlert = (plate: string) => {
    const utterance = new SpeechSynthesisUtterance(`Target acquired. Plate ${plate.split('').join(' ')}.`);
    utterance.lang = 'en-US'; // Tom mais sério em inglês ou pt-BR
    utterance.rate = 0.8;
    window.speechSynthesis.speak(utterance);
  };

  const addLog = (msg: string) => {
    setLog(prev => [`[${new Date().toLocaleTimeString()}] > ${msg}`, ...prev].slice(0, 8));
  };

  const sendTelegramAlert = async (plate: string) => {
    if (!telegramToken || !telegramChatId) return;
    const url = `https://api.telegram.org/bot${telegramToken}/sendMessage`;
    const text = `⚠️ CLASSIFIED ALERT: TARGET ACQUIRED\nID: ${targetPlate}\nDETECTION: ${plate}\nCOORD: ENCRYPTED`;
    try {
      await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ chat_id: telegramChatId, text: text })
      });
      addLog("COMMUNICATION RELAYED TO HEADQUARTERS");
    } catch (e) { addLog("COMMS FAILURE"); }
  };

  const startMonitoring = async () => {
    if (!targetPlate || !geminiKey) {
      addLog("CRITICAL ERROR: MISSING CREDENTIALS");
      setShowSettings(true);
      return;
    }
    setIsMonitoring(true);
    addLog("SCANNER SUBSYSTEMS ONLINE");
    
    if ('wakeLock' in navigator) {
      try { wakeLockRef.current = await (navigator as any).wakeLock.request('screen'); } catch (e) {}
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: "environment", width: 1280, height: 720 } 
      });
      if (videoRef.current) videoRef.current.srcObject = stream;
    } catch (err) {
      setIsMonitoring(false);
      addLog("HARDWARE ERROR: CAMERA ACCESS DENIED");
    }
  };

  const stopMonitoring = () => {
    setIsMonitoring(false);
    setIsEcoMode(false);
    const stream = videoRef.current?.srcObject as MediaStream;
    stream?.getTracks().forEach(track => track.stop());
    wakeLockRef.current?.release();
    addLog("SYSTEM DISCONNECTED");
  };

  useEffect(() => {
    let interval: NodeJS.Timeout;
    if (isMonitoring) {
      interval = setInterval(() => captureAndAnalyze(), 5000);
    }
    return () => clearInterval(interval);
  }, [isMonitoring, targetPlate]);

  const captureAndAnalyze = async () => {
    if (!videoRef.current || !canvasRef.current) return;
    const context = canvasRef.current.getContext('2d');
    canvasRef.current.width = videoRef.current.videoWidth;
    canvasRef.current.height = videoRef.current.videoHeight;
    context?.drawImage(videoRef.current, 0, 0);
    const base64Data = canvasRef.current.toDataURL('image/jpeg', 0.4).split(',')[1];

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{
            parts: [
              { text: "Extract license plate characters. Return ONLY characters or 'NULL'." },
              { inline_data: { mime_type: "image/jpeg", data: base64Data } }
            ]
          }]
        })
      });
      const data = await response.json();
      const detectedText = data.candidates[0].content.parts[0].text.trim().toUpperCase();

      if (detectedText !== "NULL" && detectedText !== "NADA") {
        addLog(`TRACKING: ${detectedText}`);
        if (detectedText.includes(targetPlate.toUpperCase())) {
          addLog("!!! TARGET POSITIVE MATCH !!!");
          speakAlert(detectedText);
          sendTelegramAlert(detectedText);
        }
      }
    } catch (e) { console.log("AI_TIMEOUT"); }
  };

  return (
    <div className={`flex flex-col items-center min-h-screen transition-all duration-700 ${isEcoMode ? 'bg-black' : 'bg-[#0a0f14]'} text-[#4ade80] font-mono p-4 overflow-hidden`}>
      
      {/* SCANLINE EFFECT OVERLAY */}
      <div className="fixed inset-0 pointer-events-none opacity-[0.03] bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-50 bg-[length:100%_2px,3px_100%]" />

      {!isEcoMode && (
        <div className="w-full max-w-md flex justify-between items-center mb-6 border-b border-[#1a2e35] pb-4">
          <div className="flex flex-col">
            <h1 className="font-bold flex items-center gap-2 text-[#4ade80] text-sm tracking-tighter">
              <ShieldAlert size={18} className="text-red-500" /> CLASSIFIED OPS - OS26.1
            </h1>
            <span className="text-[8px] text-[#2d4f5a]">SECURITY LEVEL: ALPHA-7</span>
          </div>
          <button onClick={() => setShowSettings(!showSettings)} className="p-2 border border-[#1a2e35] bg-[#0d151c] rounded-md text-[#2d4f5a] hover:text-[#4ade80]">
            <Settings size={18}/>
          </button>
        </div>
      )}

      <div className={`w-full max-w-md space-y-4 ${isEcoMode ? 'opacity-0' : ''}`}>
        
        {showSettings && (
          <div className="p-4 bg-[#0d151c] border-l-2 border-red-500 space-y-3 mb-4 text-[10px]">
            <p className="text-red-500 font-bold tracking-widest underline mb-2 italic">ACCESS_PROTOCOL_REQUIRED</p>
            <input type="password" placeholder="GEMINI_UPLINK_KEY" className="w-full p-2 bg-black border border-[#1a2e35] rounded text-blue-400 outline-none" value={geminiKey} onChange={e => setGeminiKey(e.target.value)} />
            <input type="text" placeholder="TELEGRAM_RELAY_TOKEN" className="w-full p-2 bg-black border border-[#1a2e35] rounded text-blue-400 outline-none" value={telegramToken} onChange={e => setTelegramToken(e.target.value)} />
            <input type="text" placeholder="DESTINATION_CHAT_ID" className="w-full p-2 bg-black border border-[#1a2e35] rounded text-blue-400 outline-none" value={telegramChatId} onChange={e => setTelegramChatId(e.target.value)} />
            <button onClick={() => setShowSettings(false)} className="w-full py-2 bg-[#1a2e35] text-[#4ade80] border border-[#4ade80] hover:bg-[#4ade80] hover:text-black transition-all">ESTABLISH_CONNECTION</button>
          </div>
        )}

        {/* INPUT TARGET */}
        <div className="relative group">
          <div className="absolute -inset-0.5 bg-[#4ade80] opacity-10 group-focus-within:opacity-30 blur rounded-lg transition"></div>
          <div className="relative bg-[#0d151c] border border-[#1a2e35] rounded-lg p-1">
            <input 
              type="text" 
              placeholder="TYPE_TARGET_ID..." 
              className="w-full p-4 bg-transparent text-center text-2xl font-black uppercase tracking-[0.2em] text-[#4ade80] placeholder:text-[#1a2e35] focus:outline-none"
              value={targetPlate}
              onChange={(e) => setTargetPlate(e.target.value)}
            />
          </div>
        </div>

        {/* LIVE FEED BOX */}
        <div className="relative aspect-video bg-black border border-[#1a2e35] overflow-hidden group shadow-[0_0_15px_rgba(0,0,0,0.5)]">
          <div className="absolute inset-0 border-2 border-[#4ade80] opacity-5 z-10 pointer-events-none"></div>
          {/* UI CORNERS */}
          <div className="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-[#4ade80] z-20"></div>
          <div className="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-[#4ade80] z-20"></div>
          <div className="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-[#4ade80] z-20"></div>
          <div className="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-[#4ade80] z-20"></div>

          <video ref={videoRef} autoPlay playsInline className="w-full h-full object-cover opacity-50 contrast-125 grayscale-[0.3]" />
          <canvas ref={canvasRef} className="hidden" />

          {isMonitoring && (
            <div className="absolute top-4 left-4 z-30 flex items-center gap-2">
              <div className="w-2 h-2 bg-red-600 rounded-full animate-pulse shadow-[0_0_8px_red]"></div>
              <span className="text-[10px] font-bold text-red-500 tracking-widest shadow-black drop-shadow-md">LIVE_FEED_ACTIVE</span>
            </div>
          )}
        </div>

        {/* CONTROLS */}
        <div className="grid grid-cols-5 gap-2">
          <button 
            onClick={isMonitoring ? stopMonitoring : startMonitoring}
            className={`col-span-4 py-4 font-black tracking-widest border transition-all ${isMonitoring ? 'bg-transparent text-red-500 border-red-900 animate-pulse' : 'bg-[#1a2e35] text-[#4ade80] border-[#4ade80]'}`}
          >
            {isMonitoring ? "TERMINATE_SESSION" : "ENGAGE_SCANNER"}
          </button>
          
          <button 
            onClick={() => setIsEcoMode(true)}
            disabled={!isMonitoring}
            className="col-span-1 flex items-center justify-center bg-[#0d151c] border border-[#1a2e35] text-[#4ade80] disabled:opacity-20"
          >
            <Moon size={20} />
          </button>
        </div>

        {/* ENCRYPTED CHRONICLE (LOGS) */}
        <div className="bg-[#0a1218] border border-[#1a2e35] p-4 relative">
          <div className="flex items-center gap-2 mb-3 text-[#2d4f5a]">
            <Terminal size={12} />
            <p className="text-[8px] font-bold uppercase tracking-[0.3em]">Encrypted Chronicle</p>
          </div>
          <div className="space-y-1 h-32 overflow-hidden flex flex-col justify-end">
            {log.length === 0 && <p className="text-[#1a2e35] text-[10px] italic">STANDING BY for signal...</p>}
            {log.map((l, i) => (
              <div key={i} className={`text-[9px] ${l.includes('!!!') ? 'text-red-500 font-bold' : 'text-[#4ade80]'} leading-tight opacity-80`}>
                {l}
              </div>
            ))}
          </div>
        </div>
      </div>

      {/* ECO MODE (BLACK SCREEN) */}
      {isEcoMode && (
        <button 
          onClick={() => setIsEcoMode(false)} 
          className="fixed inset-0 w-full h-full flex flex-col items-center justify-center bg-[#000508] z-[100]"
        >
          <div className="text-[#0a1a10] flex flex-col items-center gap-4">
             <Zap size={40} className="animate-pulse opacity-20" />
             <div className="h-[1px] w-24 bg-current opacity-10"></div>
             <p className="text-[8px] tracking-[2em] translate-x-4 opacity-10 uppercase">Deep Sleep Active</p>
          </div>
        </button>
      )}
    </div>
  );
