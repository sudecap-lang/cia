import streamlit as st
import requests
import base64
import time
from PIL import Image
from io import BytesIO

# --- CONFIGURA√á√ÉO VISUAL DE AG√äNCIA ---
st.set_page_config(page_title="CIA OPS STATION", layout="centered")

def apply_custom_styles():
    st.markdown("""
        <style>
        /* Fundo e Cores Globais */
        .stApp { background-color: #020405; color: #1e3a8a; font-family: 'Courier New', monospace; }
        
        /* Mapa Mundi Din√¢mico */
        .map-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.12;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/e/ec/World_map_blank_without_borders.svg');
            background-size: 300%; filter: invert(1) sepia(1) saturate(5) hue-rotate(190deg);
            animation: moveMap 120s linear infinite; z-index: -1;
        }
        @keyframes moveMap { from { background-position: 0% 50%; } to { background-position: 100% 50%; } }

        /* Elementos da Interface */
        .stTextInput>div>div>input { background-color: #000 !important; color: #3b82f6 !important; border: 1px solid #1e3a8a !important; text-align: center; font-weight: bold; }
        .stButton>button { background-color: #05080a; color: #3b82f6; border: 1px solid #1e3a8a; width: 100%; height: 3em; transition: 0.3s; }
        .stButton>button:hover { background-color: #1e3a8a; color: #fff; border-color: #3b82f6; }
        
        /* Logs do Terminal */
        .log-container { background-color: rgba(0,0,0,0.9); border: 1px solid #0c1a3d; padding: 15px; border-radius: 5px; font-size: 11px; color: #1e40af; min-height: 150px; }
        .log-entry { border-bottom: 1px solid #0c1a3d; padding: 2px 0; }
        .match-alert { color: #ff0000; font-weight: bold; text-shadow: 0 0 5px #ff0000; }
        </style>
        <div class="map-bg"></div>
        """, unsafe_allow_html=True)

apply_custom_styles()

# --- GERENCIAMENTO DE ESTADO ---
if 'auth' not in st.session_state: st.session_state.auth = False
if 'logs' not in st.session_state: st.session_state.logs = []

def add_log(msg, alert=False):
    t = time.strftime("%H:%M:%S")
    style = "match-alert" if alert else ""
    st.session_state.logs.insert(0, f"<div class='log-entry {style}'>[{t}] > {msg}</div>")

# --- M√ìDULO DE LOGIN ---
if not st.session_state.auth:
    st.markdown("<h1 style='text-align: center; letter-spacing: 12px; color: #1e3a8a; font-size: 18px;'>CLASSIFIED ACCESS</h1>", unsafe_allow_html=True)
    col1, col2, col3 = st.columns([1,2,1])
    with col2:
        pin = st.text_input("AGENT_KEY", type="password")
        if pin == "0000":
            st.session_state.auth = True
            add_log("PROTOCOL_ALPHA: SESSION START")
            st.rerun()
    st.stop()

# --- M√ìDULO PRINCIPAL ---
st.markdown("### üõ∞Ô∏è SATELLITE_LINK: CAMPOS_RJ")

with st.sidebar:
    st.title("‚öôÔ∏è CONFIG_UPLINK")
    gemini_key = st.text_input("GEMINI_API_KEY", type="password")
    tg_token = st.text_input("TELEGRAM_TOKEN", type="password")
    tg_chat = st.text_input("CHAT_ID")
    st.divider()
    if st.button("TERMINATE_SESSION"):
        st.session_state.auth = False
        st.rerun()

# --- ENTRADA DE ALVO E C√ÇMERA ---
target = st.text_input("TARGET_PLATE_ID (EX: BRA2E19)", placeholder="ABC1234").upper()
img_file = st.camera_input("OPTICAL_SCANNER")

if img_file and gemini_key and target:
    # 1. Converter imagem
    bytes_data = img_file.getvalue()
    b64_img = base64.b64encode(bytes_data).decode('utf-8')
    add_log("FRAME_CAPTURED: PROCESSING...")

    # 2. IA Gemini
    api_url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={gemini_key}"
    payload = {
        "contents": [{
            "parts": [
                {"text": "Identify car license plate. Return ONLY the plate string or 'NULL'."},
                {"inline_data": {"mime_type": "image/jpeg", "data": b64_img}}
            ]
        }]
    }

    try:
        response = requests.post(api_url, json=payload).json()
        detected = response['candidates'][0]['content']['parts'][0]['text'].strip().upper()
        
        if detected != "NULL":
            add_log(f"DETECTION_CONFIRMED: {detected}")
            
            # 3. Verifica√ß√£o de Alvo
            if target in detected:
                add_log(f"!!! POSITIVE MATCH: {detected} !!!", alert=True)
                st.toast("TARGET ACQUIRED", icon="üö®")
                
                # 4. Notifica√ß√£o Telegram
                if tg_token and tg_chat:
                    msg = f"üö® CIA ALERT: TARGET {detected} LOCATED AT CAMPOS_RJ"
                    requests.post(f"https://api.telegram.org/bot{tg_token}/sendMessage", 
                                 data={"chat_id": tg_chat, "text": msg})
        else:
            add_log("SCANNING... NO MATCH")
    except Exception as e:
        add_log(f"UPLINK_ERROR: CONNECTION_TIMEOUT")

# --- TERMINAL DE LOGS ---
st.markdown("<br>", unsafe_allow_html=True)
st.markdown("##### üìú ENCRYPTED_CHRONICLE")
log_html = f"<div class='log-container'>{''.join(st.session_state.logs[:8])}</div>"
st.markdown(log_html, unsafe_allow_html=True)
